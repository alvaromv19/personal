<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVO Financial Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        brand: { blue: '#3b82f6', green: '#10b981', red: '#ef4444', orange: '#f59e0b' }
                    },
                    fontFamily: { mono: ['monospace'], sans: ['system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>body { background-color: #0f172a; color: #f8fafc; }</style>
</head>
<body class="p-6">

    <script>
        // TUS LINKS REALES YA CONFIGURADOS
        const URL_PERSONAL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOdBRmrPd4KcOxECZQt0uTNqkJ64uGVL_toRiSPjzKwx8zxEhPvHvaC7_qQeQn3GadcJpiObSS9sK0/pub?gid=50339649&single=true&output=csv";
        const URL_EMPRESA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOdBRmrPd4KcOxECZQt0uTNqkJ64uGVL_toRiSPjzKwx8zxEhPvHvaC7_qQeQn3GadcJpiObSS9sK0/pub?gid=755120241&single=true&output=csv";
        const URL_CONFIG = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOdBRmrPd4KcOxECZQt0uTNqkJ64uGVL_toRiSPjzKwx8zxEhPvHvaC7_qQeQn3GadcJpiObSS9sK0/pub?gid=238892353&single=true&output=csv";
    </script>

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-10 border-b border-dark-700 pb-6">
            <div>
                <h1 class="text-3xl font-bold tracking-tight flex items-center gap-3">
                    <i data-lucide="wallet" class="text-brand-blue"></i> EVO FINANCIAL OS
                </h1>
                <p class="text-slate-400 text-sm mt-1 font-mono" id="fecha-header">CARGANDO...</p>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-slate-500 font-mono uppercase">TIPO DE CAMBIO</div>
                <div class="font-mono font-bold text-brand-green text-xl" id="tc-display">...</div>
            </div>
        </header>

        <div id="loading" class="text-center py-20 animate-pulse text-brand-blue font-mono">
            ANALIZANDO DATOS...
        </div>

        <div id="dashboard" class="hidden">
            
            <div id="debug-info" class="mb-6 p-2 bg-red-900/20 text-red-400 text-xs font-mono hidden rounded"></div>

            <h2 class="text-xl font-bold mb-6 flex items-center gap-3 text-slate-300">
                <span class="w-1 h-6 bg-brand-blue rounded-full"></span> NEGOCIO (USD)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div class="bg-dark-800 p-6 rounded-2xl border border-dark-700">
                    <div class="text-[10px] font-bold text-slate-500 tracking-widest uppercase mb-2">PROFIT NETO</div>
                    <div class="text-3xl font-mono font-bold text-white" id="biz-profit">$0.00</div>
                    <div class="text-xs text-slate-500 mt-1">Cash Flow Real</div>
                </div>
                <div class="bg-dark-800 p-6 rounded-2xl border border-dark-700">
                    <div class="text-[10px] font-bold text-slate-500 tracking-widest uppercase mb-2">FACTURACIÓN</div>
                    <div class="text-3xl font-mono font-bold text-brand-green" id="biz-ingresos">$0.00</div>
                    <div class="text-xs text-slate-500 mt-1">Ingresos Totales</div>
                </div>
                <div class="bg-dark-800 p-6 rounded-2xl border border-dark-700">
                    <div class="text-[10px] font-bold text-slate-500 tracking-widest uppercase mb-2">GASTOS OPERATIVOS</div>
                    <div class="text-3xl font-mono font-bold text-brand-red" id="biz-gastos">$0.00</div>
                    <div class="text-xs text-slate-500 mt-1">Sin incluir nómina</div>
                </div>
            </div>

            <h2 class="text-xl font-bold mb-6 flex items-center gap-3 text-slate-300">
                <span class="w-1 h-6 bg-brand-green rounded-full"></span> PERSONAL (PEN)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-dark-800 p-6 rounded-2xl border border-dark-700 border-l-4 border-l-brand-blue">
                    <div class="text-[10px] font-bold text-slate-500 tracking-widest uppercase mb-2">MI NÓMINA</div>
                    <div class="text-2xl font-mono font-bold text-brand-blue" id="per-nomina">S/ 0.00</div>
                    <div class="text-xs text-slate-500 mt-1">Base: $<span id="base-nomina-usd">0</span> USD</div>
                </div>
                <div class="bg-dark-800 p-6 rounded-2xl border border-dark-700">
                    <div class="text-[10px] font-bold text-slate-500 tracking-widest uppercase mb-2">GASTOS VIDA</div>
                    <div class="text-2xl font-mono font-bold text-brand-orange" id="per-gastos">S/ 0.00</div>
                    <div class="text-xs text-slate-500 mt-1">Consumo real</div>
                </div>
                <div class="bg-dark-800 p-6 rounded-2xl border border-dark-700" id="card-saldo">
                    <div class="text-[10px] font-bold text-slate-500 tracking-widest uppercase mb-2">SALDO / AHORRO</div>
                    <div class="text-2xl font-mono font-bold text-white" id="per-saldo">S/ 0.00</div>
                    <div class="text-xs text-slate-500 mt-1" id="txt-saldo">Disponible</div>
                </div>
                <div class="bg-dark-800 p-6 rounded-2xl border border-dark-700">
                    <div class="text-[10px] font-bold text-slate-500 tracking-widest uppercase mb-2">DEUDA TARJETA</div>
                    <div class="text-2xl font-mono font-bold text-brand-red" id="per-deuda">S/ 0.00</div>
                    <div class="text-xs text-slate-500 mt-1">A pagar prox. mes</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-dark-800 p-6 rounded-2xl border border-dark-700 col-span-2">
                    <h3 class="text-xs font-bold text-slate-500 mb-6 tracking-widest uppercase">Distribución de Gastos</h3>
                    <div class="h-64 relative w-full">
                        <canvas id="chartPersonal"></canvas>
                    </div>
                </div>
                
                <div class="bg-dark-800 p-6 rounded-2xl border border-dark-700 flex flex-col justify-center items-center text-center">
                    <div id="health-indicator" class="text-4xl font-mono font-bold mb-2 text-white">---</div>
                    <div class="text-xs text-slate-500 uppercase tracking-widest">Estado Financiero</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- FUNCIÓN CLAVE: PARSEADOR DE FECHAS LATINO (DD/MM/YYYY) ---
        function parseLatamDate(dateStr) {
            if (!dateStr) return null;
            // Si viene como "23/01/2026"
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                // new Date(Year, Month-1, Day)
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            // Fallback por si acaso viene en formato gringo
            return new Date(dateStr);
        }

        async function init() {
            const dateOptions = { month: 'long', year: 'numeric' };
            const today = new Date();
            document.getElementById('fecha-header').innerText = today.toLocaleDateString('es-PE', dateOptions).toUpperCase();

            Promise.all([
                fetchCSV(URL_CONFIG),
                fetchCSV(URL_EMPRESA),
                fetchCSV(URL_PERSONAL)
            ]).then(([configData, empresaData, personalData]) => {
                procesarDatos(configData, empresaData, personalData);
            }).catch(err => {
                console.error(err);
                document.getElementById('loading').innerText = "ERROR DE CONEXIÓN";
            });
        }

        function fetchCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: false, 
                    complete: (results) => resolve(results.data),
                    error: (err) => reject(err)
                });
            });
        }

        function procesarDatos(config, empresa, personal) {
            const today = new Date();
            const currentMonth = today.getMonth(); // 0 = Enero
            const currentYear = today.getFullYear(); // 2026

            // 1. Configuración
            let tc = 3.5; // Default según tu CSV
            let nominaUSD = 400; // Default según tu CSV

            // Buscar en todas las filas de config
            config.forEach(row => {
                if(row[0] && row[0].includes("TIPO DE CAMBIO")) tc = parseFloat(row[1]);
                if(row[0] && row[0].includes("NOMINA FIJA")) nominaUSD = parseFloat(row[1]);
            });

            document.getElementById('tc-display').innerText = `S/ ${tc.toFixed(2)}`;
            document.getElementById('base-nomina-usd').innerText = nominaUSD;

            // 2. Procesar Empresa
            let bizIngresos = 0, bizGastos = 0, bizNominaPagada = 0;
            let debugRows = 0;

            empresa.forEach((row, index) => {
                if (index === 0) return; // Saltar cabecera
                
                // DATA EMPRESA: Col 0 es Fecha, Col 1 es Tipo, Col 5 es Monto USD Calculado
                const fecha = parseLatamDate(row[0]);
                
                if (fecha && fecha.getMonth() === currentMonth && fecha.getFullYear() === currentYear) {
                    debugRows++;
                    const tipo = row[1] || "";
                    // Limpieza agresiva de números (quita comas si existen)
                    const montoRaw = row[5] ? String(row[5]).replace(/,/g, '') : "0";
                    const monto = parseFloat(montoRaw) || 0;

                    if (tipo.includes("Ingreso")) bizIngresos += monto;
                    if (tipo.includes("Gasto")) bizGastos += monto;
                    if (tipo.includes("Nómina")) bizNominaPagada += monto;
                }
            });

            // 3. Procesar Personal
            let perGastos = 0, perDeuda = 0;
            let categorias = {};

            personal.forEach((row, index) => {
                if (index === 0) return; // Saltar cabecera

                // DATA PERSONAL: Col 0 es Fecha, Col 1 Cat, Col 3 Monto, Col 4 Metodo
                const fecha = parseLatamDate(row[0]);

                if (fecha && fecha.getMonth() === currentMonth && fecha.getFullYear() === currentYear) {
                    const cat = row[1] || "Otros";
                    const montoRaw = row[3] ? String(row[3]).replace(/,/g, '') : "0";
                    const monto = parseFloat(montoRaw) || 0;
                    const metodo = row[4] || "";

                    perGastos += monto;
                    categorias[cat] = (categorias[cat] || 0) + monto;

                    if (metodo.toLowerCase().includes("crédito")) perDeuda += monto;
                }
            });

            // Debug visual por si acaso
            if (bizIngresos === 0 && bizGastos === 0 && perGastos === 0) {
                 const debugEl = document.getElementById('debug-info');
                 debugEl.classList.remove('hidden');
                 debugEl.innerText = `ALERTA: Se encontraron filas pero ninguna coincide con la fecha actual (${currentMonth + 1}/${currentYear}). Verifica que las fechas en el Excel sean de este mes.`;
            }

            // Cálculos Finales
            const profit = bizIngresos - bizGastos - bizNominaPagada;
            const nominaPEN = bizNominaPagada * tc; 
            const saldo = nominaPEN - perGastos;

            // Renderizar
            fmt('biz-profit', profit, '$');
            fmt('biz-ingresos', bizIngresos, '$');
            fmt('biz-gastos', bizGastos, '$');

            fmt('per-nomina', nominaPEN, 'S/ ');
            fmt('per-gastos', perGastos, 'S/ ');
            fmt('per-saldo', saldo, 'S/ ');
            fmt('per-deuda', perDeuda, 'S/ ');

            // Estilos
            const saldoEl = document.getElementById('per-saldo');
            const txtSaldo = document.getElementById('txt-saldo');
            const healthEl = document.getElementById('health-indicator');

            if (saldo < 0) {
                saldoEl.className = "text-2xl font-mono font-bold text-brand-red";
                txtSaldo.innerText = "DÉFICIT";
                healthEl.innerText = "CRÍTICO";
                healthEl.className = "text-4xl font-mono font-bold mb-2 text-brand-red";
            } else {
                saldoEl.className = "text-2xl font-mono font-bold text-brand-green";
                healthEl.innerText = "SALUDABLE";
                healthEl.className = "text-4xl font-mono font-bold mb-2 text-brand-green";
            }

            renderChart(categorias);

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function fmt(id, val, sign) {
            document.getElementById(id).innerText = sign + val.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function renderChart(dataObj) {
            // Destruir chart previo si existe (para evitar bugs de redraw)
            const ctx = document.getElementById('chartPersonal').getContext('2d');
            if (window.myPersonalChart) window.myPersonalChart.destroy();

            window.myPersonalChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataObj),
                    datasets: [{
                        data: Object.values(dataObj),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#64748b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8', font: { family: 'monospace' }, boxWidth: 10 } }
                    }
                }
            });
        }

        init();
    </script>
</body>
</html>
